<!DOCTYPE html>
<html>
<head>
    <title>CALEFAMILY</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      .sender-message {
        text-align: right;
        background-color: #f4a261; /* orange */
        margin: 5px 0;
        padding: 8px;
        border-radius: 10px;
        display: block;
        max-width: 70%;
        align-self: flex-end;
        color: black;
      }

      .receiver-message {
        text-align: left;
        background-color: #a3d5f7; /* changed to a lighter blue */
        margin: 5px 0;
        padding: 8px;
        border-radius: 10px;
        display: block;
        max-width: 70%;
        align-self: flex-start;
        color: black;
      }
    </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #ffd166;">
    <div>üåü Welcome to CaleFamily! üåü</div>
    <div>
      {% if session.get('user_id') %}
        <a href="{{ url_for('inbox') }}" style="background-color: #06d6a0; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none; margin-right:8px;">
          üì¨ Inbox
          {% if unread_count > 0 %}
            <span style="background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">
              {{ unread_count }}
            </span>
          {% endif %}
        </a>
        <a href="{{ url_for('profile') }}" style="background-color: #06d6a0; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">
          üë§ Profile
        </a>
      {% endif %}
    </div>
  </div>

  {% if session.get('user_id') %}
    <p>Welcome, {{ session['username'] }}! <a href="{{ url_for('logout') }}">Log Out</a></p>
  {% else %}
    <p><a href="{{ url_for('login') }}">Log In</a> or <a href="{{ url_for('register') }}">Register</a></p>
  {% endif %}

  <h1>CALEFAMILY</h1>
  <a href="{{ url_for('calengineers') }}" style="background-color: #ef476f; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">üõ†Ô∏è Calengineers</a>

  <ul>
    {% for subcale in subcales %}
      <li><a href="/subcale/{{ subcale.name }}">{{ subcale.emoji }} {{ subcale.name }}</a></li>
    {% endfor %}
  </ul>
</body>

<div id="chat-box" style="display: flex; max-width: 800px; margin: 0 auto;">
  <div id="user-list" style="width: 200px; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; max-height: 400px;"></div>
  <div style="flex: 1; display: flex; flex-direction: column;">
    <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
    <textarea id="msg-input" placeholder="Type a message..."></textarea>
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
  let otherUserId = null;
  let selectedUserDiv = null;
  const currentUserId = {{ session['user_id'] }};

  function sendMessage() {
    const content = document.getElementById('msg-input').value;
    if (!otherUserId || !content.trim()) return;

    fetch('/api/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipient_id: otherUserId, content })
    }).then(() => {
      document.getElementById('msg-input').value = '';
      fetchMessages();
    });
  }

  function loadUsers() {
    fetch('/api/users')
      .then(res => res.json())
      .then(data => {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        data.forEach(user => {
          const div = document.createElement('div');
          div.textContent = user.username;
          div.setAttribute('data-user-id', user.id);
          div.setAttribute('data-base-name', user.username);
          div.style.cursor = 'pointer';
          div.style.padding = '5px 0';
          div.onclick = () => {
            otherUserId = user.id;
            fetchMessages();
            if (selectedUserDiv) {
              selectedUserDiv.classList.remove('selected-user');
            }
            div.classList.add('selected-user');
            selectedUserDiv = div;
          };
          userList.appendChild(div);
        });
      });
  }

  function fetchMessages() {
    if (!otherUserId) return;
    fetch(`/api/messages?other_id=${otherUserId}`)
      .then(res => res.json())
      .then(data => {
        const messages = data.messages;
        const unreadCounts = data.unread_counts;

        const box = document.getElementById('messages');
        box.innerHTML = '';

        messages.forEach(msg => {
          const el = document.createElement('div');
          const isSender = msg.sender_id === currentUserId;
          el.textContent = `${isSender ? 'You' : msg.sender_name}: ${msg.content}`;
          el.className = isSender ? 'sender-message' : 'receiver-message';
          box.appendChild(el);
        });

      // Update user list
      document.querySelectorAll('#user-list div').forEach(div => {
        const userId = parseInt(div.getAttribute('data-user-id'));
        const baseName = div.getAttribute('data-base-name');
        if (userId !== otherUserId && unreadCounts[userId]) {
          div.textContent = `${baseName} (${unreadCounts[userId]})`;
        } else {
          div.textContent = baseName;
        }
      });

    box.scrollTop = box.scrollHeight;
  });
  }
  // Ensure users are loaded and chat refreshes when page loads
  document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    setInterval(fetchMessages, 3000);
  });
</script>

</html>
