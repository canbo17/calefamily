<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=0.3">
<head>
    <title>CALEFAMILY</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      .sender-message {
        text-align: right;
        background-color: #f4a261; /* orange */
        margin: 5px 0;
        padding: 8px;
        border-radius: 10px;
        display: block;
        max-width: 70%;
        align-self: flex-end;
        color: black;
      }

      .receiver-message {
        text-align: left;
        background-color: #a3d5f7; /* changed to a lighter blue */
        margin: 5px 0;
        padding: 8px;
        border-radius: 10px;
        display: block;
        max-width: 70%;
        align-self: flex-start;
        color: black;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
      }

      .status-online {
        background-color: green;
      }

      .status-recently-online {
        background-color: orange;
      }

      .status-offline {
        background-color: red;
      }
    </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #ffd166;">
    <div>🌟 Welcome to CaleFamily! 🌟</div>
    <div>
      {% if session.get('user_id') %}
        <a href="{{ url_for('calengineers') }}" style="background-color: #ef476f; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">🛠️ Calengineers</a>
        <a href="{{ url_for('inbox') }}" style="background-color: #d577ea; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none; margin-right:8px;">
          📬 Inbox
          {% if unread_count > 0 %}
            <span style="background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">
              {{ unread_count }}
            </span>
          {% endif %}
          <a href="{{ url_for('profile') }}" style="background-color: #06d6a0; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">
            <img src="{{ url_for('static', filename='images/user_' ~ session['user_id'] ~ '.jpg') }}"
               onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default.jpg') }}';"
               alt="Profile" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 6px; vertical-align: middle;">
            Profile
          </a>
      {% endif %}
    </div>
  </div>

  {% if session.get('user_id') %}
    <p>Welcome, {{ session['username'] }}! <a href="{{ url_for('logout') }}">Log Out</a></p>
  {% else %}
    <p><a href="{{ url_for('login') }}">Log In</a> or <a href="{{ url_for('register') }}">Register</a></p>
  {% endif %}

<div style="display: flex; align-items: flex-start; gap: 40px; margin-top: 20px;">
  <ul style="list-style: none; padding: 0; margin: 0; min-width: 200px;">
    <h1>CALEFAMILY</h1>
    {% for subcale in subcales %}
    <li>
      <a href="/subcale/{{ subcale.name | lower | replace('ñ', 'n') }}">
        {{ subcale.emoji }} {{ subcale.name }}
      </a>
    </li>
    {% endfor %}
  </ul> 

  <div class="tidy-blocks" style="flex-grow: 1;">
  <div style="padding: 20px; width: 100%; max-width: 800px; border: 1px solid #ccc; border-radius: 10px;">
  <h3 style="text-align:center;">🌍 Multi-language Translator</h3>
  <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
    <div>
      <label>🇺🇸 English</label><br>
      <textarea id="englishBox" rows="4" cols="30"></textarea>
    </div>
    <div>
      <label>🇪🇸 Español</label><br>
      <textarea id="spanishBox" rows="4" cols="30"></textarea>
    </div>
    <div>
      <label>🇹🇷 Türkçe</label><br>
      <textarea id="turkishBox" rows="4" cols="30"></textarea>
    </div>
  </div>
  <div style="text-align: center; margin-top: 10px;">
    <button onclick="translateText()" style="margin-right: 10px;">Translate</button>
    <button onclick="clearText()" style="background-color: orange; color: white;">Clear</button>
  </div>
  </div>

  <div id="chat-box" style="display: flex; width: 100%; max-width: 800px; margin: 0;">
  <div id="user-list" style="width: 200px; border-right: 1px solid #ccc; padding: 10px; overflow-y: auto; max-height: 400px;"></div>
  <div style="flex: 1; display: flex; flex-direction: column;">
    <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
    <textarea id="msg-input" placeholder="Type a message..."></textarea>
    <button onclick="sendMessage()">Send</button>
  </div>
  </div>


</div>
</div>

<script>
  async function translateText() {
    const en = document.getElementById('englishBox').value.trim();
    const es = document.getElementById('spanishBox').value.trim();
    const tr = document.getElementById('turkishBox').value.trim();

    let sourceText, sourceLang;
    if (en) {
      sourceText = en;
      sourceLang = 'en';
    } else if (es) {
      sourceText = es;
      sourceLang = 'es';
    } else if (tr) {
      sourceText = tr;
      sourceLang = 'tr';
    } else {
      alert("Please enter text in one of the boxes.");
      return;
    }

    const targets = ['en', 'es', 'tr'].filter(lang => lang !== sourceLang);
    for (const targetLang of targets) {
      const res = await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&dt=t&sl=" +
        sourceLang + "&tl=" + targetLang + "&q=" + encodeURIComponent(sourceText));
      const data = await res.json();
      const translatedText = data[0].map(item => item[0]).join(" ");
      if (targetLang === 'en') document.getElementById('englishBox').value = translatedText;
      if (targetLang === 'es') document.getElementById('spanishBox').value = translatedText;
      if (targetLang === 'tr') document.getElementById('turkishBox').value = translatedText;
    }
  }
  function clearText() {
    document.getElementById('englishBox').value = '';
    document.getElementById('spanishBox').value = '';
    document.getElementById('turkishBox').value = '';
  }
</script>

<script>
    let otherUserId = null;
    let selectedUserDiv = null;
    const currentUserId = {{ session['user_id'] }};
  
    function sendMessage() {
      const content = document.getElementById('msg-input').value;
      if (!otherUserId || !content.trim()) return;
  
      fetch('/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ recipient_id: otherUserId, content })
      }).then(() => {
        document.getElementById('msg-input').value = '';
        fetchMessages();
      });
    }
  
    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(data => {
          const userList = document.getElementById('user-list');
          userList.innerHTML = '';
          data.forEach(user => {
            const div = document.createElement('div');
            let statusClass = 'status-offline';
            if (user.status === 'online') statusClass = 'status-online';
            else if (user.status === 'recently-online') statusClass = 'status-recently-online';
  
            div.innerHTML = `<span class="status-indicator ${statusClass}"></span>${user.username}`;
            
            div.setAttribute('data-user-id', user.id);
            div.setAttribute('data-base-name', user.username);
            div.setAttribute('data-user-status', user.status);
            div.style.cursor = 'pointer';
            div.style.padding = '5px 0';
            div.onclick = () => {
              otherUserId = user.id;
              fetchMessages();
              if (selectedUserDiv) {
                selectedUserDiv.classList.remove('selected-user');
              }
              div.classList.add('selected-user');
              selectedUserDiv = div;
            };
            userList.appendChild(div);
          });
        });
    }
  
    function fetchMessages() {
      if (!otherUserId) return;
      fetch(`/api/messages?other_id=${otherUserId}`)
        .then(res => res.json())
        .then(data => {
          const messages = data.messages;
          const unreadCounts = data.unread_counts;
  
          const box = document.getElementById('messages');
          box.innerHTML = '';
  
          messages.forEach(msg => {
            const el = document.createElement('div');
            const isSender = msg.sender_id === currentUserId;
            el.textContent = `${isSender ? 'You' : msg.sender_name}: ${msg.content}`;
            el.className = isSender ? 'sender-message' : 'receiver-message';
            box.appendChild(el);
          });
  
        fetch('/api/users')
          .then(res => res.json())
          .then(users => {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            users.forEach(user => {
              const div = document.createElement('div');
              let statusClass = 'status-offline';
              if (user.status === 'online') statusClass = 'status-online';
              else if (user.status === 'recently-online') statusClass = 'status-recently-online';
  
              const unreadText = (user.id !== otherUserId && unreadCounts[user.id])
                ? ` (${unreadCounts[user.id]})`
                : '';
  
              div.innerHTML = `<span class="status-indicator ${statusClass}"></span>${user.username}${unreadText}`;
              div.setAttribute('data-user-id', user.id);
              div.setAttribute('data-base-name', user.username);
              div.setAttribute('data-user-status', user.status);
              div.style.cursor = 'pointer';
              div.style.padding = '5px 0';
              if (selectedUserDiv && selectedUserDiv.getAttribute('data-user-id') == user.id) {
                div.classList.add('selected-user');
                selectedUserDiv = div;
              }
              div.onclick = () => {
                otherUserId = user.id;
                fetchMessages();
                if (selectedUserDiv) {
                  selectedUserDiv.classList.remove('selected-user');
                }
                div.classList.add('selected-user');
                selectedUserDiv = div;
              };
              userList.appendChild(div);
            });
          });
  
      box.scrollTop = box.scrollHeight;
    });
    }

    function fetchUnreadCounts() {
      fetch(`/api/messages?other_id=${otherUserId || ''}`)
        .then(res => res.json())
        .then(data => {
          const unreadCounts = data.unread_counts;
          document.querySelectorAll('#user-list div').forEach(div => {
            const userId = parseInt(div.getAttribute('data-user-id'));
            const baseName = div.getAttribute('data-base-name');
            const status = div.getAttribute('data-user-status') || 'offline';

            let statusClass = 'status-offline';
            if (status === 'online') statusClass = 'status-online';
            else if (status === 'recently-online') statusClass = 'status-recently-online';

            const unreadText = (userId !== otherUserId && unreadCounts[userId])
              ? ` (${unreadCounts[userId]})`
              : '';

            div.innerHTML = `<span class="status-indicator ${statusClass}"></span>${baseName}${unreadText}`;
          });
        });
    }

    // Ensure users are loaded and chat refreshes when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();
      setInterval(fetchMessages, 3000);
      setInterval(fetchUnreadCounts, 2000); // updates unread badges regularly
    });
  </script>

<script>
  setInterval(() => {
    fetch('/update_last_seen', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(res => console.log("Pinged /update_last_seen:", res.status))
      .catch(err => console.error("Ping failed:", err));
  }, 5000);
</script>

</html>
