<!DOCTYPE html>
<html>
<head>
    {% set display_name = subcale_name.replace('n', '√±') if subcale_name.lower() == 'calespanol' else subcale_name %}
    <title>{{ display_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #ffd166;">
        <div>üåü Welcome to CaleFamily! üåü</div>
        <div>    
        {% if session.get('user_id') %}
            <a href="{{ url_for('home') }}" style="background-color: #118ab2; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">üè° Go Home</a>            <a href="{{ url_for('calengineers') }}" style="background-color: #ef476f; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">üõ†Ô∏è Calengineers</a>
            <a href="{{ url_for('inbox') }}" style="background-color: #d577ea; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none; margin-right:8px;">
            üì¨ Inbox
            {% if unread_count > 0 %}
                <span style="background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">
                {{ unread_count }}
                </span>
            {% endif %}
            <a href="{{ url_for('profile') }}" style="background-color: #06d6a0; padding: 10px 15px; border-radius: 10px; color: white; text-decoration: none;">
                <img src="{{ url_for('static', filename='images/user_' ~ session['user_id'] ~ '.jpg') }}"
                    onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default.jpg') }}';"
                    alt="Profile" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 6px; vertical-align: middle;">
                Profile
            </a>
        {% endif %}
        </div>
    </div>
</head>
{% block scripts %}{% endblock %}
<body>
  {% block content %}
    {% set subcale_images = {
        'caleducation': 'caleducation.jpg',
        'caleengineers': 'caleengineers.jpg',
        'calentertainment': 'calentertainment.jpg',
        'calecho': 'calecho.jpg',
        'calexplore': 'calexplore.jpg',
        'calenrichment': 'calenrichment.jpg',
        'calespanol': 'calespanol.jpg'
    } %}

    {% block navigation %}
    <ul>
    {% for subcale in subcales %}
        <li>
        <a href="/subcale/{{ subcale.name | lower | replace('√±', 'n') }}">
            {{ subcale.emoji }} {{ subcale.name }}
        </a>
        </li>
    {% endfor %}
    </ul>
    {% endblock %}

    {% block extra_content %}{% endblock %}
    {% block body_text %}{% endblock %}

    {% if not self.extra_content() %}
      <img class="subcale-banner" src="{{ url_for('static', filename='images/' + subcale_images[subcale_name.lower()|replace('√±', 'n')]) }}" alt="{{ display_name }} image" style="max-width: 100%; height: auto;">
    {% endif %}

    <h1>{{ display_name }}</h1>

    <h2>Create a New Post</h2>
    <form method="POST">
        <textarea name="content" rows="4" cols="50" required></textarea><br><br>
        <input type="submit" value="Post">
    </form>

    <h2>Posts</h2>
    <ul>
        {% for post in posts %}
            <li style="margin-bottom: 20px;">

                <!-- DEBUG: session='{{ session['username'] }}', post_author='{{ post[1] }}' -->
                {% if current_user == post[1] %}
                    <form method="GET" action="{{ url_for('edit_post', post_id=post[0], subcale_name=subcale_name) }}" style="display:inline;">
                        <button type="submit" style="padding: 2px 6px; font-size: 0.9em;">Edit</button>
                    </form>
                    <form method="POST" action="{{ url_for('delete_post', post_id=post[0], subcale_name=subcale_name) }}" style="display:inline;">
                        <button type="submit" style="color: red; padding: 2px 6px; font-size: 0.9em;">Delete</button>
                    </form>
                {% endif %}
                <!-- Reaction Buttons (Fixed: Ensure post[3], post[4], etc. are treated as numbers) -->
                <div style="margin-top: 10px;">
                    <form method="post" action="{{ url_for('react', post_id=post[0], reaction='heart') }}" style="display:inline;">
                        <button type="submit" {% if (post[3]|int if post[3] is iterable else post[3]) > 0 %}style="background-color: #ff6f61; color: white;"{% endif %}>
                            ‚ù§Ô∏è {{ post[3][0] if post[3] is iterable and not post[3] is string else post[3] }}
                        </button>
                    </form>

                    <form method="post" action="{{ url_for('react', post_id=post[0], reaction='laugh') }}" style="display:inline;">
                        <button type="submit" {% if (post[4]|int if post[4] is iterable else post[4]) > 0 %}style="background-color: #ffcc00; color: white;"{% endif %}>
                            üòÇ {{ post[4][0] if post[4] is iterable and not post[4] is string else post[4] }}
                        </button>
                    </form>

                    <form method="post" action="{{ url_for('react', post_id=post[0], reaction='note') }}" style="display:inline;">
                        <button type="submit" {% if (post[5]|int if post[5] is iterable else post[5]) > 0 %}style="background-color: #42aaff; color: white;"{% endif %}>
                            üéµ {{ post[5][0] if post[5] is iterable and not post[5] is string else post[5] }}
                        </button>
                    </form>

                    <form method="post" action="{{ url_for('react', post_id=post[0], reaction='thumb') }}" style="display:inline;">
                        <button type="submit" {% if (post[6]|int if post[6] is iterable else post[6]) > 0 %}style="background-color: #4caf50; color: white;"{% endif %}>
                            üëç {{ post[6][0] if post[6] is iterable and not post[6] is string else post[6] }}
                        </button>
                    </form>
                </div>

                <div class="post-card">
                    <b>{{ post[1] }}</b>: {{ post[2] }}
                </div> 

                <!-- Display reactions for comments -->
                {% for comment in post[7] %}
                    <li style="font-size: 0.9em; color: #555; margin-top: 5px;">
                        <i>{{ comment[0] }}</i>: {{ comment[1] }}
                        
                        <!-- Reactions for comments (Fixed similarly) -->
                        <div style="margin-top: 10px;">
                            <form method="post" action="{{ url_for('react', post_id=post[0], reaction='heart') }}" style="display:inline;">
                                <input type="hidden" name="comment_id" value="{{ comment[2] }}">
                                <button type="submit" {% if (comment[3]|int if comment[3] is iterable else comment[3]) > 0 %}style="background-color: #ff6f61; color: white;"{% endif %}>
                                    ‚ù§Ô∏è {{ comment[3][0] if comment[3] is iterable and not comment[3] is string else comment[3] }}
                                </button>
                            </form>
                            <form method="post" action="{{ url_for('react', post_id=post[0], reaction='laugh') }}" style="display:inline;">
                                <input type="hidden" name="comment_id" value="{{ comment[2] }}">
                                <button type="submit" {% if (comment[4]|int if comment[4] is iterable else comment[4]) > 0 %}style="background-color: #ffcc00; color: white;"{% endif %}>
                                    üòÇ {{ comment[4][0] if comment[4] is iterable and not comment[4] is string else comment[4] }}
                                </button>
                            </form>
                            <form method="post" action="{{ url_for('react', post_id=post[0], reaction='note') }}" style="display:inline;">
                                <input type="hidden" name="comment_id" value="{{ comment[2] }}">
                                <button type="submit" {% if (comment[5]|int if comment[5] is iterable else comment[5]) > 0 %}style="background-color: #42aaff; color: white;"{% endif %}>
                                    üéµ {{ comment[5][0] if comment[5] is iterable and not comment[5] is string else comment[5] }}
                                </button>
                            </form>
                            <form method="post" action="{{ url_for('react', post_id=post[0], reaction='thumb') }}" style="display:inline;">
                                <input type="hidden" name="comment_id" value="{{ comment[2] }}">
                                <button type="submit" {% if (comment[6]|int if comment[6] is iterable else comment[6]) > 0 %}style="background-color: #4caf50; color: white;"{% endif %}>
                                    üëç {{ comment[6][0] if comment[6] is iterable and not comment[6] is string else comment[6] }}
                                </button>
                            </form>
                        </div>
                        
                        {% if current_user == comment[0] %}
                            [<a href="{{ url_for('edit_comment', comment_id=comment[2]) }}">Edit</a>]
                            [<a href="{{ url_for('delete_comment', comment_id=comment[2]) }}" style="color: red;">Delete</a>]
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>

                <!-- Add a Comment -->
                <form action="{{ url_for('add_comment', post_id=post[0]) }}" method="POST" style="margin-top: 10px;">
                    <input type="text" name="comment" placeholder="Add a comment..." required style="width: 70%;">
                    <input type="submit" value="Comment">
                </form>
            </li>
        {% endfor %}
    </ul>
  {% endblock %}
</body>
</html>